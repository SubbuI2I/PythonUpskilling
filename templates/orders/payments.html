{% extends 'base.html' %}
{% load static %}

{% block content %}

<section class="section-content padding-y bg">
    <div class="container">
    
    <!-- ============================ COMPONENT 1 ================================= -->
    <div class="row">
    <aside class="col-lg-8">
    <div class="card">
        <h5 class="card-header">Billing Address</h5>
        <div class="card-body">
            <p class="card-text mb-0"><b> Name: </b> {{order.full_name}} </p>
            <p class="card-text mb-0"><b> Address: </b> 
                {{ order.address_line_1 }} {{order.address_line_2}} <br/>
                 {{order.city}}, {{order.state}} <br/> 
                {{order.country }} , {{ order.zipcode }} </p>
            <p class="card-text mb-0"><b> Phone: </b> {{order.phone }} </p>
            <p class="card-text mb-0"><b> Email: </b> {{order.email }} </p>
            {% if order.order_note %}
                <b>Order Note: </b> {{order.order_note}}
            {% endif %}
        </div>
        </div>
    <div class="card">
        <h5 class="card-header">Payment Method</h5>
        <div class="card-body">
            Paypal 
        </div>
    </div>
    <div class="card">
        <h5 class="card-header">Review</h5>
        <div class="card-body">
            <table class="table table-borderless table-shopping-cart">
                <thead class="text-muted">
                    <tr class="small text-uppercase">
                        <th scope="col">Product</th>
                        <th scope="col" width="120">Quantity</th>
                        <th scope="col" width="120">Price</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in cart_items %}
                    <tr>
                        <td>
                            <figure class="itemside align-items-center">
                                <div class="aside"><img src="{{item.product.images.url}}" class="img-sm">
                                </div>
                                <figcaption class="info">
                                    <a href="{{ item.product.get_url }}"
                                        class="title text-dark">{{item.product.product_name}}</a>
                                    <p class="text-muted small">
                                        {% if item.variations.all%}
                                        {% for item in item.variations.all%}
                                            {{ item.variation_category | capfirst }} :
                                            {{ item.variation_value | capfirst }}
                                        <br />
                                        {% endfor %}
                                        {% endif %}
                                    </p>

                                </figcaption>
                            </figure>
                        </td>
                        <td>
                            <!-- col.// -->
                            <div class="col">
                                <div class="input-group input-spinner">
                                    <label>{{item.quantity}}</label>
                                </div> <!-- input-group.// -->
                            </div> <!-- col.// -->
                        </td>
                        <td>
                            <div class="price-wrap">
                                <var class="price">$ {{item.sub_total}} </var>
                                <small class="text-muted">$ {{item.product.price}} each </small>
                            </div> <!-- price-wrap .// -->
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>   
        </div>
        </div>
    </aside> <!-- col.// -->
        <aside class="col-lg-4">
        
                <div class="card">
                <div class="card-body">
                    <dl class="dlist-align">
                    <dt>Total Price:</dt>
                    <dd class="text-right">$ {{total}}</dd>
                    </dl>
                    <dl class="dlist-align">
                        <dt>Tax:</dt>
                        <dd class="text-right">$ {{tax}}</dd>
                    </dl>
                    <hr>
                    <dl class="dlist-align">
                        <dt>Grand Total:</dt>
                        <dd class="text-right">$ {{grand_total}}</dd>
                    </dl>
                    <p class="text-center mb-3">
                        <img src="{% static './images/misc/payments.png' %}" height="26">
                    </p>
            <!-- Set up a container element for the button -->
            <div id="paypal-button-container">
                    
            </div>
                </div> <!-- card-body.// -->
                </div> <!-- card.// -->
        
        </aside> <!-- col.// -->
    </div> <!-- row.// -->
    <!-- ============================ COMPONENT 1 END .// ================================= -->
    
    </div> <!-- container .//  -->
    </section>
    <!-- ========================= SECTION CONTENT END// ========================= -->

    <script type="text/javascript" >

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            // Does this cookie string begin with the name we want?
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
        var csrftoken = getCookie('csrftoken');
        var total_amount = "{{ grand_total }}";
        var url = "{% url 'payments' %}"
        var orderId = "{{ order.order_number }}"
        var payment_method = 'Paypal'

        // Render the PayPal button into #paypal-button-container
        paypal.Buttons({

            style: {
                color:  'blue',
                shape:  'pill',
                label:  'pay',
                height: 40
            },
            
            // Call your server to set up the transaction
            createOrder: function(data, actions) {
                return actions.order.create({
                    purchase_units:[{
                        amount:{
                            value: total_amount
                        }
                    }]
                })
                 // server 
                // return fetch('/demo/checkout/api/paypal/order/create/', {
                //     method: 'post'
                // }).then(function(res) {
                //     return res.json();
                // }).then(function(orderData) {
                //     return orderData.id;
                // });
            },
            
            onApprove: function(data, actions){
                return actions.order.capture().then(function(details) {
                        alert('Transaction completed by ' + details.payer.name.given_name )
                        console.log(details)
                        sendData();
                        function sendData(){
                            try {
                            const response =  fetch(url, {
                                method: "POST", // or 'PUT'
                                headers: {
                                    "Content-Type": "application/json",
                                    "X-CSRFToken": csrftoken
                                },
                                body: JSON.stringify({
                                    orderId:orderId,
                                    payment_method: payment_method,
                                    transId: details.id,
                                    status: details.status
                                }),
                            });
                            const result = response.json();
                            console.log("Success:", result);
                        } catch (error) {
                            console.error("Error:", error);
                        }
                    }
                });
            }
            // Call your server to finalize the transaction
            // onApprove: function(data, actions) {
            //     return fetch('/demo/checkout/api/paypal/order/' + data.orderID + '/capture/', {
            //         method: 'post'
            //     }).then(function(res) {
            //         return res.json();
            //     }).then(function(orderData) {
            //         // Three cases to handle:
            //         //   (1) Recoverable INSTRUMENT_DECLINED -> call actions.restart()
            //         //   (2) Other non-recoverable errors -> Show a failure message
            //         //   (3) Successful transaction -> Show confirmation or thank you

            //         // This example reads a v2/checkout/orders capture response, propagated from the server
            //         // You could use a different API or structure for your 'orderData'
            //         var errorDetail = Array.isArray(orderData.details) && orderData.details[0];

            //         if (errorDetail && errorDetail.issue === 'INSTRUMENT_DECLINED') {
            //             return actions.restart(); // Recoverable state, per:
            //             // https://developer.paypal.com/docs/checkout/integration-features/funding-failure/
            //         }

            //         if (errorDetail) {
            //             var msg = 'Sorry, your transaction could not be processed.';
            //             if (errorDetail.description) msg += '\n\n' + errorDetail.description;
            //             if (orderData.debug_id) msg += ' (' + orderData.debug_id + ')';
            //             return alert(msg); // Show a failure message (try to avoid alerts in production environments)
            //         }

            //         // Successful capture! For demo purposes:
            //         console.log('Capture result', orderData, JSON.stringify(orderData, null, 2));
            //         var transaction = orderData.purchase_units[0].payments.captures[0];
            //         alert('Transaction '+ transaction.status + ': ' + transaction.id + '\n\nSee console for all available details');

            //         // Replace the above to show a success message within this page, e.g.
            //         // const element = document.getElementById('paypal-button-container');
            //         // element.innerHTML = '';
            //         // element.innerHTML = '<h3>Thank you for your payment!</h3>';
            //         // Or go to another URL:  actions.redirect('thank_you.html');
            //     });
            // }

        }).render('#paypal-button-container');
    </script>

{% endblock %}